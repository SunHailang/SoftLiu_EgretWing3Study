"use strict";var egret3d,__reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function __extends(t,e){function r(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);r.prototype=e.prototype,t.prototype=new r},__decorate=this&&this.__decorate||function(t,e,i,r){var s,o=arguments.length,n=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,i,r);else for(var a=t.length-1;0<=a;a--)(s=t[a])&&(n=(o<3?s(n):3<o?s(e,i,n):s(e,i))||n);return 3<o&&n&&Object.defineProperty(e,i,n),n};!function(a){!function(C){function vec3(){return a.Vector3.create().release()}function vec3Add(t,e){return vec3().add(t,e)}function vec3Substract(t,e){return vec3().subtract(t,e)}function vec3Mutiply(t,e){return vec3().multiplyScalar(e,t)}var t=function(){function TrailBatcher(t,e){this._maxFragmentCount=300,this._points=[],this._pausedTime=-1,this._verticles=[],this._uvs=[],this._colors=[],this._indices=[],this._pointDistances=[0],this._distanceSum=0,this._gameObject=t,this._comp=e,this._onPausedChanged=this._onPausedChanged.bind(this),this._onEmittingChanged=this._onEmittingChanged.bind(this)}return TrailBatcher.prototype.pause=function(){this._pausedTime=paper.clock.timestamp()},TrailBatcher.prototype.initialize=function(){this._comp.onPausedChanged.add(this._onPausedChanged),this._comp.onEmittingChanged.add(this._onEmittingChanged),this._createMesh()},TrailBatcher.prototype.uninitialize=function(){this._comp.onPausedChanged.remove(this._onPausedChanged),this._comp.onEmittingChanged.remove(this._onEmittingChanged),this._releaseMesh()},Object.defineProperty(TrailBatcher.prototype,"gameObject",{get:function(){return this._gameObject},enumerable:!0,configurable:!0}),TrailBatcher.prototype.resume=function(){this._pausedTime<0&&console.warn("_pausedTime should not be less than 0 in TrailBatcher.resume()");for(var t=paper.clock.timestamp()-this._pausedTime,e=0,i=this._points;e<i.length;e++){i[e].timeCreated+=t}},TrailBatcher.prototype.update=function(t){if(this._comp){var e=this._comp;if(!e.paused)if(!e.emitting&&e.autoDestruct&&this._points.length<2)e.gameObject.destroy();else{var i=paper.clock.timestamp();this._updateSegments(i),this._rebuildMeshData(i),this._composeMesh()}}},TrailBatcher.prototype._reset=function(){this._points.length=0,this._lastPosition=null,this._pausedTime=-1,this._distanceSum=0,this._pointDistances.length=1,this._resetMeshData()},TrailBatcher.prototype._updateSegments=function(t){var e=this._comp;if(!e.paused){var i=e.transform.position,r=this._lastPosition?i.getDistance(this._lastPosition):-1,s=this._points.length,o=this._points[s-1];if(e.emitting)if(r>e.minVertexDistance||r<0){if(this._points.push({position:a.Vector3.create().copy(i),timeCreated:t}),this._lastPosition||(this._lastPosition=a.Vector3.create()),this._lastPosition.copy(i),o){var n=o.position.getDistance(i);this._pointDistances.push(n),this._distanceSum+=n}}else if(0<s&&(o.position.copy(i),o.timeCreated=t,1<s)){n=o.position.getDistance(this._points[s-2].position);this._distanceSum=this._distanceSum-this._pointDistances[s-1]+n,this._pointDistances[s-1]=n}this._removeDeadPoints(t,1e3*e.time)}},TrailBatcher.prototype._removeDeadPoints=function(t,e){var i=this._points.length;if(0!==i)for(var r=0;r<i;r++)if(t-this._points[r].timeCreated<e){if(0<r){this._points.splice(0,r);for(var s=0;s<r;s++)this._distanceSum-=this._pointDistances[s];this._pointDistances.splice(0,r)}break}},TrailBatcher.prototype._rebuildMeshData=function(t){this._resetMeshData();var e=this._points.length;if(!(e<2)){var i=this._getCamera();if(i)for(var r,s,o=this._comp,n=0,a=o.gameObject.transform.worldToLocalMatrix,h=!1,p=null,c=0;c<e;++c){var l=this._points[c],_=(t-l.timeCreated)/(1e3*o.time),u=this._getColorSample(o,_),m=this._getWidthSample(o,_),d=0===c?vec3Substract(l.position,this._points[c+1].position):vec3Substract(this._points[c-1].position,l.position),g=o.Alignment===C.TrailAlignment.View?vec3Substract(i.transform.position,l.position):o.gameObject.transform.getForward(vec3()),f=(r=d,s=g,vec3().cross(r,s)).normalize();o.autoFlip&&0<c&&p&&p.dot(d)<0&&(h=!h),p=d;var v=vec3Add(l.position,vec3Mutiply(f,.5*m)).applyMatrix(a),T=vec3Add(l.position,vec3Mutiply(f,.5*-m)).applyMatrix(a);if(h){var y=v;v=T,T=y}switch(o.textureMode){case C.TrailTextureMode.Stretch:n=this._buildMeshForTextureStretch(v,T,u,c,n);break;case C.TrailTextureMode.PerSegment:this._buildMeshForTexturePerSegment(v,T,c)}}}},TrailBatcher.prototype._buildMeshForTextureStretch=function(t,e,i,r,s){var o=6*r;if(this._verticles[o+0]=t.x,this._verticles[o+1]=t.y,this._verticles[o+2]=t.z,this._verticles[o+3]=e.x,this._verticles[o+4]=e.y,this._verticles[o+5]=e.z,o=8*r,this._colors[o+0]=i.r,this._colors[o+1]=i.g,this._colors[o+2]=i.b,this._colors[o+3]=i.a,this._colors[o+4]=i.r,this._colors[o+5]=i.g,this._colors[o+6]=i.b,this._colors[o+7]=i.a,s+=this._distanceSum?this._pointDistances[r]/this._distanceSum:0,o=4*r,this._uvs[o+0]=s,this._uvs[o+1]=1,this._uvs[o+2]=s,(this._uvs[o+3]=0)<r){o=6*(r-1);var n=2*r;this._indices[o+0]=n-2,this._indices[o+1]=n-1,this._indices[o+2]=n,this._indices[o+3]=1+n,this._indices[o+4]=n,this._indices[o+5]=n-1}return s},TrailBatcher.prototype._buildMeshForTexturePerSegment=function(t,e,i){var r=12*(i-1)+6;this._verticles[r+0]=t.x,this._verticles[r+1]=t.y,this._verticles[r+2]=t.z,this._verticles[r+3]=e.x,this._verticles[r+4]=e.y,this._verticles[r+5]=e.z;var s=8*(i-1)+4,o=0<i?1:0;if(this._uvs[s+0]=o,this._uvs[s+1]=1,this._uvs[s+2]=o,(this._uvs[s+3]=0)<i&&i<this._points.length){i<this._points.length&&(r+=6,this._verticles[r+0]=t.x,this._verticles[r+1]=t.y,this._verticles[r+2]=t.z,this._verticles[r+3]=e.x,this._verticles[r+4]=e.y,this._verticles[r+5]=e.z,s+=4,o=0,this._uvs[s+0]=o,this._uvs[s+1]=1,this._uvs[s+2]=o,this._uvs[s+3]=0);var n=6*(i-1),a=4*(i-1)+2;this._indices[0+n]=a-2,this._indices[1+n]=a-1,this._indices[2+n]=a-0,this._indices[3+n]=1+a,this._indices[4+n]=a-0,this._indices[5+n]=a-1}},TrailBatcher.prototype._getColorSample=function(t,e){var i=a.Color.create();if(t.color.length&&0<t.color.length){var r=(e=1<(e=e<0?0:e)?1:e)*(t.color.length-1),s=Math.floor(r),o=Math.ceil(r);if(o<=s)i.copy(t.color[s]);else{var n=(r-s)/(o-s);i.lerp(t.color[s],t.color[o],n)}}else i.copy(t.color);return i},TrailBatcher.prototype._getWidthSample=function(t,e){var i=0;if(t.width.length&&0<t.width.length){var r=(e=1<(e=e<0?0:e)?1:e)*(t.width.length-1),s=Math.floor(r),o=Math.ceil(r);if(o<=s)i=t.width[s];else{var n=(r-s)/(o-s);i=t.width[s]+n*(t.width[o]-t.width[s])}}else i=t.width;return i},TrailBatcher.prototype._getCamera=function(){return a.Camera.main},TrailBatcher.prototype._resetMeshData=function(){this._verticles.length=0,this._uvs.length=0,this._colors.length=0,this._indices.length=0},TrailBatcher.prototype._composeMesh=function(){if(this._points.length>this._maxFragmentCount&&(this._maxFragmentCount=this._points.length,this._createMesh()),this._mesh){var t=this._mesh.getAttributes("POSITION");t&&t.fill(0),this._mesh.setAttributes("POSITION",this._verticles),(t=this._mesh.getAttributes("TEXCOORD_0"))&&t.fill(0),this._mesh.setAttributes("TEXCOORD_0",this._uvs),(t=this._mesh.getAttributes("COLOR_0"))&&t.fill(0),this._mesh.setAttributes("COLOR_0",this._colors),(t=this._mesh.getIndices())&&t.fill(0),this._mesh.setIndices(this._indices),this._mesh.uploadVertexBuffer(),this._mesh.uploadSubIndexBuffer(0)}},TrailBatcher.prototype._createMesh=function(){this._mesh=a.Mesh.create(4*(this._maxFragmentCount-1),6*(this._maxFragmentCount-1),["POSITION","TEXCOORD_0","COLOR_0"]);var t=this._comp.gameObject.getComponent(a.MeshFilter);t?t.mesh=this._mesh:console.warn("no MeshFilter on Trail object("+this._comp.gameObject.name+")")},TrailBatcher.prototype._releaseMesh=function(){var t=this._comp.gameObject.getComponent(a.MeshFilter);t?(t.mesh===this._mesh&&(t.mesh=null),this._mesh=null):console.warn("no MeshFilter on Trail object("+this._comp.gameObject.name+")")},TrailBatcher.prototype._onPausedChanged=function(){this._comp.paused?this.pause():this.resume()},TrailBatcher.prototype._onEmittingChanged=function(){this._comp.emitting&&this._reset()},TrailBatcher}();C.TrailBatcher=t,__reflect(t.prototype,"egret3d.trail.TrailBatcher")}(a.trail||(a.trail={}))}(egret3d||(egret3d={})),function(n){!function(t){var i,e,r,s;(e=i=t.TrailAlignment||(t.TrailAlignment={})).View="View",e.Local="Local",(s=r=t.TrailTextureMode||(t.TrailTextureMode={})).Stretch="Stretch",s.PerSegment="PerSegment";var o=function(e){function TrailComponent(){var t=null!==e&&e.apply(this,arguments)||this;return t.time=3,t.minVertexDistance=.1,t.width=1,t.color=n.Color.WHITE,t.autoDestruct=!1,t.autoFlip=!1,t.Alignment=i.View,t.textureMode=r.Stretch,t.onEmittingChanged=new signals.Signal,t._emitting=!0,t.onPausedChanged=new signals.Signal,t._paused=!1,t}return __extends(TrailComponent,e),Object.defineProperty(TrailComponent.prototype,"emitting",{get:function(){return this._emitting},set:function(t){this._emitting!==t&&(this._emitting=t,this.onEmittingChanged.dispatch(t))},enumerable:!0,configurable:!0}),Object.defineProperty(TrailComponent.prototype,"paused",{get:function(){return this._paused},set:function(t){this._paused!==t&&(this._paused=t,this.onPausedChanged.dispatch(t))},enumerable:!0,configurable:!0}),__decorate([paper.serializedField,paper.editor.property("FLOAT",{minimum:0})],TrailComponent.prototype,"time",void 0),__decorate([paper.serializedField,paper.editor.property("FLOAT",{minimum:0})],TrailComponent.prototype,"minVertexDistance",void 0),__decorate([paper.serializedField,paper.editor.property("FLOAT",{minimum:0})],TrailComponent.prototype,"width",void 0),__decorate([paper.serializedField,paper.editor.property("CHECKBOX")],TrailComponent.prototype,"autoDestruct",void 0),__decorate([paper.serializedField,paper.editor.property("CHECKBOX")],TrailComponent.prototype,"autoFlip",void 0),__decorate([paper.serializedField,paper.editor.property("LIST",{listItems:paper.editor.getItemsFromEnum(n.trail.TrailAlignment)})],TrailComponent.prototype,"Alignment",void 0),__decorate([paper.serializedField,paper.editor.property("LIST",{listItems:paper.editor.getItemsFromEnum(n.trail.TrailTextureMode)})],TrailComponent.prototype,"textureMode",void 0),__decorate([paper.serializedField,paper.editor.property("CHECKBOX")],TrailComponent.prototype,"emitting",null),__decorate([paper.serializedField,paper.editor.property("CHECKBOX")],TrailComponent.prototype,"paused",null),TrailComponent=__decorate([paper.requireComponent(n.MeshFilter),paper.requireComponent(n.MeshRenderer)],TrailComponent)}(paper.BaseComponent);t.TrailComponent=o,__reflect(o.prototype,"egret3d.trail.TrailComponent")}(n.trail||(n.trail={}))}(egret3d||(egret3d={})),function(i){var r,t;r=i.trail||(i.trail={}),t=function(e){function TrailSystem(){var t=null!==e&&e.apply(this,arguments)||this;return t._batchers=[],t}return __extends(TrailSystem,e),TrailSystem.prototype.getMatchers=function(){return[paper.Matcher.create(i.Transform,i.MeshFilter,i.MeshRenderer,r.TrailComponent)]},TrailSystem.prototype.onEntityAdded=function(t){var e=t.getComponent(r.TrailComponent);if(e){var i=new r.TrailBatcher(t,e);i.initialize(),this._batchers.push(i)}},TrailSystem.prototype.onEntityRemoved=function(t){for(var e=0;e<this._batchers.length;e++){var i=this._batchers[e];if(i.gameObject===t)return i.uninitialize(),void this._batchers.splice(e,1)}},TrailSystem.prototype.onFrame=function(e){this._batchers.map(function(t){return t.update(e)})},TrailSystem}(paper.BaseSystem),r.TrailSystem=t,__reflect(t.prototype,"egret3d.trail.TrailSystem"),r.createTrail=function createTrail(t){var e=i.creater.createGameObject(t);return e.addComponent(i.trail.TrailComponent),e},paper.Application.systemManager.preRegister(t,paper.Application.gameObjectContext,6999)}(egret3d||(egret3d={}));